---
- hosts: all
  tasks:
    - name: Install ansible-galaxy
      become: true
      ansible.builtin.apt:
        name: ansible
        update_cache: yes
        state: present

    - name: Install python3-openstacksdk
      become: true
      ansible.builtin.apt:
        name: python3-openstacksdk
        state: present

    - name: Install collection openstack.cloud
      community.general.ansible_galaxy_install:
        type: collection
        name: openstack.cloud

    - name: Create cloud config dir
      ansible.builtin.file:
        path: "~/.config/openstack"
        state: directory
        recurse: true
        mode: "0700"

    - name: Create cloud config file
      ansible.builtin.copy:
        content: "{{ clouds_conf.credentials }}"
        dest: "~/.config/openstack/clouds.yaml"
        mode: "0600"
      no_log: true

    - name: Copy Tests on the node
      ansible.builtin.copy:
        src: "../../Tests"
        dest: "~/"
        mode: 0666
      no_log: false

    - name: Run compliance script
      ansible.builtin.shell:
        cmd: python3 ~/Tests/scs-compliance-check.py scs-compatible.yaml iaas --os-cloud wavestack
        chdir: /home/ubuntu/Tests
      register: result

    - debug:
        msg: "{{ result.stdout }}"