---
- name: Build and Push Container Image
  hosts: "all"

  vars:
    image_name: "{{ (docker_registry | default('registry.scs.community')) + '/' + registry_project + '/' + (container_name | default( zuul.project.short_name )) }}"

  tasks:
    - name: "Log into registry"
      community.docker.docker_login:
        registry_url: "{{ docker_registry }}"
        username: "{{ secret.DOCKER_USERNAME }}"
        password: "{{ secret.DOCKER_PASSWORD }}"
      when: push_image | bool

    - name: "Build Container"
      community.docker.docker_image_build:
        name: "{{ image_name }}"
        tag: "{{ zuul['tag'] | default('latest') }}"
        path: "{{ zuul.project.src_dir + (containerfile_path | default('')) }}"
        labels:
          org.opencontainers.image.created: "{{ ansible_date_time.iso8601 | quote }}"
          org.opencontainers.image.documentation: "{{ docs_link | default('https://docs.scs.community') | quote }}"
          org.opencontainers.image.licenses: "{{ licenses | default('') | quote }}"
          org.opencontainers.image.revision: "{{ zuul.commit_id | quote }}}"
          org.opencontainers.image.source: "{{ zuul.project.canonical_name | quote }}"
          org.opencontainers.image.title: "{{ container_name | default( zuul.project.short_name ) | quote }}"
          org.opencontainers.image.url: "{{ zuul.project.canonical_name | quote }}"
          org.opencontainers.image.vendor: "Sovereign Cloud Stack SCS"
          org.opencontainers.image.version: "{{ zuul['tag'] | default('latest') | quote }}"
      changed_when: true

    - name: "Push Image to Registry"
      community.docker.docker_image_push:
        name: "{{ image_name }}"
        tag: "{{ zuul['tag'] | default('latest') }}"
      when: push_image | bool
      changed_when: true
      no_log: true
